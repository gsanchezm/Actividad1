name: bench-linux-windows-with-plots

on:
  workflow_dispatch:

jobs:
  bench:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # -------- Build (Linux) --------
      - name: Build benchmark (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          cd ejercicio7
          g++ -std=c++17 -O2 -Wall -Wextra \
            apps/benchmark.cpp avl/AVLTree.cpp btree/BTree.cpp btree/DiskStorage.cpp \
            -o bench

      # -------- Run (Linux) --------
      - name: Run benchmark (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          cd ejercicio7
          ./bench
          mv bench.csv bench_linux.csv

      # -------- Build (Windows) --------
      - name: Build benchmark (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd ejercicio7
          g++ -std=c++17 -O2 -Wall -Wextra `
            apps/benchmark.cpp avl/AVLTree.cpp btree/BTree.cpp btree/DiskStorage.cpp `
            -o bench.exe

      # -------- Run (Windows) --------
      - name: Run benchmark (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd ejercicio7
          .\bench.exe
          Rename-Item -Path bench.csv -NewName bench_windows.csv

      # -------- Upload CSVs --------
      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: bench-${{ matrix.os }}
          path: ejercicio7/bench_*.csv

  plot:
    needs: bench
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download CSV artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bench-*
          merge-multiple: true
          path: artifacts

      - name: Show downloaded files
        shell: bash
        run: |
          ls -la artifacts

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install matplotlib
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install matplotlib

      - name: Generate comparison plots
        shell: bash
        run: |
          # Copiar CSVs al folder del ejercicio
          cp artifacts/bench_linux.csv ejercicio7/bench_linux.csv
          cp artifacts/bench_windows.csv ejercicio7/bench_windows.csv

          cd ejercicio7
          # OJO: tu archivo se llama plot_bench_compare.py seg√∫n tu screenshot
          python plot_bench_compare.py

      - name: Upload plot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bench-plots
          path: |
            ejercicio7/bench_linux.csv
            ejercicio7/bench_windows.csv
            ejercicio7/bench_compare_insert.png
            ejercicio7/bench_compare_search.png
